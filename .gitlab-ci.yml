stages:
  - validate
  - infra_plan
  - infra_apply
  - build
  - package
  - deploy
  - cleanup

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  ECR_REGISTRY: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
  ECR_REPOSITORY: ${REPO_NAME}
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  S3_BUCKET_NAME: "votre-bucket-angular-ici" # Assurez-vous que ce bucket est créé par Terraform

# --- 0. PACKAGE LAMBDA ZIP (doit être AVANT terraform plan/apply) ---
# On le met en stage validate pour qu’il soit disponible en infra_plan/infra_apply via artifacts.
package_lambda:
  stage: validate
  image: node:20-alpine
  script:
    - apk add --no-cache zip
    - mkdir -p dist
    - test -f lambda/worker/index.js
    # zip avec index.js à la racine (handler = index.handler)
    - cd lambda/worker
    - zip -r ../../dist/lambda_nodejs.zip index.js
  artifacts:
    paths:
      - dist/lambda_nodejs.zip
    expire_in: 1 hour
  rules:
    - changes:
        - lambda/worker/**/*

# --- 1. TERRAFORM STAGES (Ciblant le dossier /terraform/dev) ---

terraform_validate:
  stage: validate
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  script:
    - cd terraform/dev
    - terraform init -backend=false
    - terraform validate

terraform_plan:
  stage: infra_plan
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  dependencies:
    - package_lambda
  script:
    - cd terraform/dev
    - terraform init
    # Le zip est récupéré dans le workspace via artifacts, donc chemin absolu CI_PROJECT_DIR
    - terraform plan -out=tfplan -var="lambda_zip_path=${CI_PROJECT_DIR}/dist/lambda_nodejs.zip"
  artifacts:
    paths:
      - terraform/dev/tfplan
    expire_in: 1 hour

terraform_apply:
  stage: infra_apply
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  dependencies:
    - terraform_plan
    - package_lambda
  script:
    - cd terraform/dev
    - terraform init
    - terraform apply -auto-approve tfplan
  when: manual

# --- 2. BUILD STAGE (Java & Angular) ---

build_backend:
  stage: build
  image: maven:3.8.5-openjdk-17
  script:
    - cd product-service
    - chmod +x mvnw
    - ./mvnw clean package -DskipTests
  artifacts:
    paths:
      - product-service/target/*.jar
  rules:
    - changes:
        - product-service/**/*

build_frontend:
  stage: build
  image: node:18
  script:
    - cd product-service-fe
    - npm install
    - npm run build -- --configuration=production
  artifacts:
    paths:
      - product-service-fe/dist/
  rules:
    - changes:
        - product-service-fe/**/*

# --- 3. PACKAGE STAGE (Docker) ---

package_docker:
  stage: package
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
  script:
    - cd product-service
    - docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
  rules:
    - changes:
        - product-service/**/*

# --- 4. DEPLOY STAGE (ECS & S3) ---

deploy_backend_ecs:
  stage: deploy
  image: amazon/aws-cli
  script:
    - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment --region $AWS_REGION
  rules:
    - changes:
        - product-service/**/*

deploy_frontend_s3:
  stage: deploy
  image: amazon/aws-cli
  script:
    - aws s3 sync product-service-fe/dist/product-service-fe/ s3://$S3_BUCKET_NAME --delete --region $AWS_REGION
  rules:
    - changes:
        - product-service-fe/**/*

terraform_destroy:
  stage: cleanup
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  dependencies:
    - package_lambda
  script:
    - cd terraform/dev
    - terraform init
    - terraform destroy -auto-approve -var="lambda_zip_path=${CI_PROJECT_DIR}/dist/lambda_nodejs.zip"
  when: manual
  allow_failure: false