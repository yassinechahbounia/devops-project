stages:
  - validate
  - infra_plan
  - infra_apply
  - build
  - package
  - deploy
  - cleanup

variables:
  TF_INPUT: "false"
  TF_IN_AUTOMATION: "true"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  
  # Registre ECR
  ECR_REGISTRY: ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
  REPO_BACKEND: "brief3-backend"
  REPO_FRONTEND: "brief3-frontend"
  
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  # Key par défaut pour le zip dans S3
  LAMBDA_S3_KEY: "lambda/worker/lambda_nodejs.zip"

# ---------------------------------------------------------
# 0) PRÉPARATION : Lambda & Terraform Validate
# ---------------------------------------------------------
package_lambda:
  stage: validate
  image: node:20-alpine
  script:
    - apk add --no-cache zip
    - mkdir -p dist
    - cd lambda/worker && zip -r ../../dist/lambda_nodejs.zip index.js
  artifacts:
    paths:
      - dist/lambda_nodejs.zip
    expire_in: 1h

terraform_validate:
  stage: validate
  image: 
    name: hashicorp/terraform:latest
    entrypoint: [""]
  script:
    - cd terraform/dev
    - terraform init -backend=false
    - terraform validate

# ---------------------------------------------------------
# 1) INFRASTRUCTURE : Plan & Apply
# ---------------------------------------------------------
terraform_plan:
  stage: infra_plan
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  needs: ["package_lambda"]
  script:
    - cd terraform/dev
    - terraform init
    - |
      terraform plan -out=tfplan \
        -var="lambda_zip_path=${CI_PROJECT_DIR}/dist/lambda_nodejs.zip" \
        -var="image_tag=${IMAGE_TAG}" \
        -var="db_password=${TF_VAR_db_password}" \
        -var="lambda_s3_bucket=${LAMBDA_ARTIFACTS_BUCKET}" \
        -var="lambda_s3_key=${LAMBDA_S3_KEY}"
  artifacts:
    paths:
      - terraform/dev/tfplan
    expire_in: 1h

terraform_apply:
  stage: infra_apply
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  needs: ["terraform_plan", "package_lambda"]
  script:
    - cd terraform/dev
    - terraform init
    - terraform apply -auto-approve tfplan
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# ---------------------------------------------------------
# 2) BUILD : Compilation Java & Angular
# ---------------------------------------------------------
build_backend:
  stage: build
  image: maven:3.8.5-openjdk-17
  script:
    - cd product-service && chmod +x mvnw && ./mvnw clean package -DskipTests
  artifacts:
    paths:
      - product-service/target/*.jar

build_frontend:
  stage: build
  image: node:18
  script:
    - cd product-service-fe && npm install && npm run build -- --configuration=production
  artifacts:
    paths:
      - product-service-fe/dist/

# ---------------------------------------------------------
# 3) PACKAGE : Docker Push (Backend & Frontend)
# ---------------------------------------------------------
.docker_setup: &docker_setup
  image: docker:24.0.5
  services: ["docker:24.0.5-dind"]
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

package_backend:
  <<: *docker_setup
  stage: package
  needs: ["build_backend"]
  script:
    - cd product-service
    - docker build -t $ECR_REGISTRY/$REPO_BACKEND:$IMAGE_TAG .
    - docker push $ECR_REGISTRY/$REPO_BACKEND:$IMAGE_TAG
    - docker tag $ECR_REGISTRY/$REPO_BACKEND:$IMAGE_TAG $ECR_REGISTRY/$REPO_BACKEND:latest
    - docker push $ECR_REGISTRY/$REPO_BACKEND:latest

package_frontend:
  <<: *docker_setup
  stage: package
  needs: ["build_frontend"]
  script:
    - cd product-service-fe
    - docker build -t $ECR_REGISTRY/$REPO_FRONTEND:$IMAGE_TAG .
    - docker push $ECR_REGISTRY/$REPO_FRONTEND:$IMAGE_TAG
    - docker tag $ECR_REGISTRY/$REPO_FRONTEND:$IMAGE_TAG $ECR_REGISTRY/$REPO_FRONTEND:latest
    - docker push $ECR_REGISTRY/$REPO_FRONTEND:latest

# ---------------------------------------------------------
# 4) DEPLOY : Mise à jour ECS
# ---------------------------------------------------------
deploy_ecs:
  stage: deploy
  image: amazon/aws-cli
  needs: ["terraform_apply", "package_backend", "package_frontend"]
  script:
    - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment --region $AWS_REGION

# ---------------------------------------------------------
# 5) CLEANUP : Terraform Destroy
# ---------------------------------------------------------
terraform_destroy:
  stage: cleanup
  image:
    name: hashicorp/terraform:latest
    entrypoint: [""]
  script:
    - cd terraform/dev
    - terraform init
    - |
      terraform destroy -auto-approve \
        -var="lambda_zip_path=${CI_PROJECT_DIR}/dist/lambda_nodejs.zip" \
        -var="image_tag=${IMAGE_TAG}" \
        -var="db_password=${TF_VAR_db_password}" \
        -var="lambda_s3_bucket=${LAMBDA_ARTIFACTS_BUCKET}" \
        -var="lambda_s3_key=${LAMBDA_S3_KEY}"
  when: manual